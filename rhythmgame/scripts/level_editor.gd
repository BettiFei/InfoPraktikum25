extends Node2D

# set this constant before game start
const in_edit_mode : bool = false

var current_level_name = "LEGENDARY"

# time it takes for falling key to reach critical spot:
var fk_fall_time: float = 2.2
var fk_output_arr = [[],[],[],[]]

# dictionary that holds info for all levels
var level_info = {
	"LEGENDARY" = {
		"fk_times": "[[3.01600008010864, 8.10399990081787, 8.69066696166992, 13.8, 15.6453330993652, 23.1333339691162, 23.5600002288818, 24.786665725708, 30.6533325195313, 33.0319984436035, 33.7786682128906, 34.8026664733887, 35.0266654968262, 35.5706680297852, 41.0000007629395, 43.8373344421387, 46.1413314819336, 49.7360008239746, 49.885334777832, 51.1333320617676, 56.6800010681152, 57.5546653747559, 57.9706657409668, 62.4399993896484, 62.8986633300781, 65.8960006713867, 66.83466796875, 67.4640014648437, 68.0613296508789, 69.9600036621094, 70.386669921875, 71.5919998168945, 72.4986694335937, 72.6586654663086, 72.8080032348633, 72.9786651611328, 73.3626678466797, 79.4959991455078, 82.5360000610352, 83.1226699829102, 85.3946655273437, 86.2160003662109, 89.5226638793945, 90.4719970703125, 90.9413345336914, 93.3839996337891, 95.7733352661133, 96.0080001831055, 96.2000015258789, 98.4826629638672, 101.576000976563, 104.402668762207, 108.936001586914, 109.565335083008, 110.674664306641, 111.218663024902, 113.458668518066, 117.426663208008, 118.10933380127, 118.600003051758, 120.925335693359, 124.871998596191, 125.426663208008, 125.895993041992, 130.247998046875, 131.367993164063, 132.18932800293, 133.607998657227, 133.917340087891, 136.786663818359, 137.853329467773, 141.181332397461, 141.352001953125, 141.810665893555, 142.557339477539, 144.733334350586, 145.277340698242, 148.264004516602, 151.41067199707, 153.170666503906, 154.557339477539, 159.079998779297, 163.079998779297, 163.997326660156, 166.898663330078, 171.186672973633, 171.453335571289, 174.25866394043, 178.461331176758, 181.383999633789, 185.096005249023, 188.018673706055], [5.53333311080933, 10.5573337554932, 11.2293336868286, 14.3973339080811, 15.4746673583984, 18.0986660003662, 20.4133327484131, 22.813334274292, 24.4346664428711, 25.4053333282471, 27.5280006408691, 29.5546672821045, 32.317333984375, 35.7946670532227, 37.6186683654785, 38.8773315429687, 40.2959983825684, 42.9946678161621, 45.8533332824707, 49.0106666564941, 50.5893333435059, 51.1333320617676, 53.223999786377, 54.1093338012695, 54.9946678161621, 55.4533317565918, 57.2026679992676, 57.7466667175293, 58.2480018615723, 58.8986671447754, 59.6026657104492, 60.1786659240723, 60.6693351745605, 61.4693344116211, 62.1306655883789, 62.7173355102539, 63.197331237793, 64.0933349609375, 64.5839965820312, 65.0853317260742, 65.5333297729492, 66.6853302001953, 67.2933319091797, 67.9226654052734, 68.3920028686523, 69.0426681518555, 69.6613357543945, 70.2373321533203, 70.7599990844727, 71.3039978027344, 72.2533309936523, 73.1600006103516, 74.4080017089844, 75.0266693115234, 76.2106674194336, 78.6533325195312, 79.2293365478516, 81.213330078125, 83.7199981689453, 84.3920028686523, 85.1173370361328, 85.885334777832, 87.9119995117187, 88.5413330078125, 89.0853317260742, 91.2933319091797, 93.1280029296875, 93.6293304443359, 94.3120010375977, 96.5519989013672, 99.6986663818359, 101.05333404541, 103.602665710449, 104.402668762207, 105.533329772949, 106.002667236328, 106.493336486816, 106.791996765137, 108.61600189209, 109.842663574219, 110.557331848145, 111.016003417969, 113.330670166016, 113.853337097168, 117.245335388184, 117.810665893555, 118.301335144043, 118.898663330078, 119.56000213623, 120.146664428711, 120.744000244141, 121.256001281738, 121.8, 122.450665283203, 123.815998840332, 124.701336669922, 125.245335388184, 125.735997009277, 126.194668579102, 127.250668334961, 127.848004150391, 128.413327026367, 129.373333740234, 130.002667236328, 130.610668945313, 131.090664672852, 131.943997192383, 132.733334350586, 133.426663208008, 133.917340087891, 135.335995483398, 136.583996582031, 137.053326416016, 137.554669189453, 138.461331176758, 139.400006103516, 140.402661132813, 141.650662231445, 142.130673217773, 142.279995727539, 142.877331542969, 143.527996826172, 144.178662109375, 145.682659912109, 147.453335571289, 150.493328857422, 150.984005737305, 151.13332824707, 151.592007446289, 152.349331665039, 152.957333374023, 153.768002319336, 154.557339477539, 158.727993774414, 159.453335571289, 161.533337402344, 161.693325805664, 162.045330810547, 162.194668579102, 162.557339477539, 162.69599609375, 163.229336547852, 163.709332275391, 164.477337646484, 166.600003051758, 167.581326293945, 168.199993896484, 169.20266418457, 171.719998168945, 172.967999267578, 173.50133972168, 174.25866394043, 177.064007568359, 177.437329101563, 179.890667724609, 180.30666809082, 180.573330688477, 181.042660522461, 184.744000244141, 186.247998046875, 186.408001708984, 187.15466003418, 187.933331298828], [4.25333337783813, 9.30933361053467, 9.8959997177124, 15.0159996032715, 19.4426658630371, 22.0666664123535, 22.2479999542236, 25.1173332214355, 28.9253337860107, 30.0773323059082, 32.7013328552246, 35.3146675109863, 38.290665435791, 40.0933349609375, 43.4426658630371, 48.0080001831055, 48.4773338317871, 50.3120010375977, 54.6533325195312, 55.1973350524902, 55.7946670532227, 58.5786674499512, 59.9013336181641, 60.3706672668457, 68.7120025634766, 71.9119995117187, 77.4586685180664, 78.0133331298828, 80.0506637573242, 80.6479995727539, 85.5653350830078, 90.1840026855469, 90.6426666259766, 98.3120010375977, 98.8773315429687, 100.775997924805, 104.01866607666, 106.290669250488, 109.394665527344, 114.706669616699, 115.261334228516, 115.773335266113, 116.338665771484, 119.880001831055, 122.098667907715, 126.493328857422, 128.967999267578, 130.909329223633, 132.46667175293, 136.16799621582, 136.32799987793, 138.173336791992, 143.208004760742, 147.773327636719, 150.685330200195, 152.018673706055, 153.565335083008, 164.733334350586, 165.277340698242, 167.250668334961, 168.733334350586, 169.693325805664, 173.778668212891, 177.992001342773, 183.698666381836, 183.826672363281, 185.50133972168], [6.86666660308838, 11.858666229248, 12.4560001373291, 16.9146659851074, 17.1279991149902, 17.5439994812012, 18.8026664733887, 20.0719993591309, 20.6159999847412, 25.7039993286133, 26.9840000152588, 28.1573341369629, 30.6533325195313, 33.4266670227051, 36.0506675720215, 37.8639991760254, 39.4640014648437, 42.5999992370605, 45.0106666564941, 45.2560012817383, 45.5866668701172, 48.189331817627, 51.1120002746582, 52.8826683044434, 59.2720001220703, 61.1173332214355, 61.8213317871094, 64.2533309936523, 64.7333343505859, 65.2346694946289, 69.3413360595703, 71.1333358764648, 75.6560028076172, 79.0693328857422, 81.0533340454102, 84.9466674804687, 87.5706680297852, 88.2533309936523, 88.7226684570312, 92.9039962768555, 93.9066665649414, 99.5493362426758, 100.146664428711, 103.336003112793, 105.746662902832, 106.791996765137, 108.413334655762, 110.269329833984, 111.719998168945, 115.037335205078, 115.591999816895, 116.03999786377, 119.229336547852, 120.45599822998, 121.629330444336, 122.696003723145, 123.016003417969, 123.325329589844, 123.495999145508, 127.442669677734, 128.040005493164, 128.583996582031, 129.671994018555, 131.783993530273, 133.106671142578, 134.855999755859, 135.037335205078, 137.22399597168, 138.792004394531, 138.941326904297, 139.954663085938, 140.104000854492, 143.858670043945, 146.824002075195, 147.229336547852, 149.373333740234, 149.949337768555, 150.130673217773, 152.541333007813, 153.970669555664, 154.557339477539, 156.882672119141, 157.042660522461, 157.437329101563, 157.586666870117, 157.778668212891, 158.087994384766, 158.25866394043, 158.408001708984, 163.549328613281, 164.317333984375, 165.949337768555, 167.901333618164, 169.042660522461, 173.234661865234, 174.25866394043, 180.839993286133, 184.349331665039, 186.877331542969, 187.901333618164]]
",
		"music": load("res://music/Epic - Legendary - Music.wav")
	},
	"HE'S_A_PIRATE" = {
		"fk_times": "",
		"music": load("res://music/He's A Pirate - Music.wav")
	}
}

func _ready():
	$MusicPlayer.stream = level_info.get(current_level_name).get("music")
	$MusicPlayer.play()
	
	if in_edit_mode:
		Signals.KeyListenerPress.connect(KeyListenerPress)
	else:
		var fk_times = level_info.get(current_level_name).get("fk_times")
		var fk_times_arr = str_to_var(fk_times)
		
		
		var counter: int = 0
		for key in fk_times_arr:
			
			var button_name: String = ""
			match counter:
				0:
					button_name = "button_left"
				1:
					button_name = "button_down"
				2:
					button_name = "button_up"
				3:
					button_name = "button_right"
		
			for delay in key:
				spawn_falling_key(button_name, delay)
			
			counter += 1

func KeyListenerPress(button_name: String, array_num: int):
	#print(str(array_num) + " " + str($MusicPlayer.get_playback_position()))
	fk_output_arr[array_num].append($MusicPlayer.get_playback_position() - fk_fall_time)
	#print(fk_output_arr)

func spawn_falling_key(button_name: String, delay: float):
	await get_tree().create_timer(delay).timeout
	Signals.CreateFallingKey.emit(button_name)


func _on_music_player_finished() -> void:
	if in_edit_mode:
		print(fk_output_arr)
	else:
		get_tree().change_scene_to_file("res://scenes/end_screen.tscn")
